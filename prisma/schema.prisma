// Prisma Schema for Motico Solutions CRM
// Database: PostgreSQL

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// ═══════════════════════════════════════════════════════════════
// ENUMS
// ═══════════════════════════════════════════════════════════════

enum StockStatus {
  in_stock
  low_stock
  out_of_stock
}

enum Currency {
  USD
  EUR
  LBP
}

enum OrderStatus {
  pending
  confirmed
  processing
  shipped
  delivered
  cancelled
  refunded
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded
}

enum CustomerStatus {
  active
  inactive
  blocked
}

enum QuoteStatus {
  pending
  reviewed
  sent
  accepted
  rejected
  expired
  converted
}

enum MessageStatus {
  unread
  read
  replied
  archived
  spam
}

enum MessageType {
  contact
  support
  inquiry
  feedback
}

enum InventoryReason {
  sale
  return_item
  adjustment
  restock
  damaged
  initial
}

enum UserRole {
  admin
  customer
}

// ═══════════════════════════════════════════════════════════════
// USER & AUTH
// ═══════════════════════════════════════════════════════════════

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String
  role         UserRole  @default(customer)
  company      String?
  phone        String?
  avatar       String?
  isActive     Boolean   @default(true)
  country      String?
  industry     String?
  position     String?
  address      String?
  city         String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLogin    DateTime?

  // Relations
  sessions       Session[]
  inventoryLogs  InventoryLog[]
  messageReplies Message[]      @relation("RepliedBy")

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ═══════════════════════════════════════════════════════════════
// BRAND
// ═══════════════════════════════════════════════════════════════

model Brand {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  logo            String?
  description     String?
  website         String?
  countryOfOrigin String?
  isActive        Boolean  @default(true)
  sortOrder       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  products Product[]

  @@map("brands")
}

// ═══════════════════════════════════════════════════════════════
// CATEGORY (Hierarchical)
// ═══════════════════════════════════════════════════════════════

model Category {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  description  String?
  image        String?
  parentId     String?
  sortOrder    Int      @default(0)
  isActive     Boolean  @default(true)
  productCount Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Self-referential relation for hierarchy
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  // Products
  products      Product[] @relation("ProductCategory")
  subcategoryOf Product[] @relation("ProductSubcategory")

  @@map("categories")
}

// ═══════════════════════════════════════════════════════════════
// PRODUCT
// ═══════════════════════════════════════════════════════════════

model Product {
  id               String      @id @default(cuid())
  sku              String      @unique
  name             String
  slug             String      @unique
  shortDescription String?
  description      String
  features         String[]
  categoryId       String
  subcategoryId    String?
  brandId          String
  hasVariants      Boolean     @default(false)
  price            Decimal?    @db.Decimal(10, 2)
  compareAtPrice   Decimal?    @db.Decimal(10, 2)
  currency         Currency    @default(USD)
  stockQuantity    Int         @default(0)
  stockStatus      StockStatus @default(out_of_stock)
  minStockLevel    Int         @default(10)
  trackInventory   Boolean     @default(true)
  allowBackorder   Boolean     @default(false)
  isPublished      Boolean     @default(false)
  isFeatured       Boolean     @default(false)
  isNew            Boolean     @default(true)
  metaTitle        String?
  metaDescription  String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  publishedAt      DateTime?

  // Relations
  category       Category               @relation("ProductCategory", fields: [categoryId], references: [id])
  subcategory    Category?              @relation("ProductSubcategory", fields: [subcategoryId], references: [id])
  brand          Brand                  @relation(fields: [brandId], references: [id])
  images         ProductImage[]
  specifications ProductSpecification[]
  variants       ProductVariant[]
  inventoryLogs  InventoryLog[]
  orderItems     OrderItem[]
  quoteItems     QuoteItem[]

  @@map("products")
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String
  alt       String
  sortOrder Int     @default(0)
  isPrimary Boolean @default(false)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model ProductSpecification {
  id        String  @id @default(cuid())
  productId String
  key       String
  label     String
  value     String
  unit      String?
  group     String?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_specifications")
}

model ProductVariant {
  id            String  @id @default(cuid())
  productId     String
  sku           String  @unique
  name          String
  price         Decimal? @db.Decimal(10, 2)
  stockQuantity Int     @default(0)
  attributes    Json
  isActive      Boolean @default(true)

  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventoryLogs InventoryLog[]
  orderItems    OrderItem[]

  @@map("product_variants")
}

// ═══════════════════════════════════════════════════════════════
// INVENTORY LOG
// ═══════════════════════════════════════════════════════════════

model InventoryLog {
  id               String          @id @default(cuid())
  productId        String
  variantId        String?
  previousQuantity Int
  newQuantity      Int
  change           Int
  reason           InventoryReason
  notes            String?
  userId           String
  createdAt        DateTime        @default(now())

  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])
  user    User            @relation(fields: [userId], references: [id])

  @@map("inventory_logs")
}

// ═══════════════════════════════════════════════════════════════
// CUSTOMER
// ═══════════════════════════════════════════════════════════════

model Customer {
  id          String         @id @default(cuid())
  email       String         @unique
  name        String
  company     String?
  phone       String?
  address     String?
  city        String?
  region      String?
  postalCode  String?
  country     String         @default("Lebanon")
  totalOrders Int            @default(0)
  totalSpent  Decimal        @default(0) @db.Decimal(10, 2)
  lastOrderAt DateTime?
  status      CustomerStatus @default(active)
  isVerified  Boolean        @default(false)
  notes       String?
  tags        String[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  orders Order[]
  quotes Quote[]

  @@map("customers")
}

// ═══════════════════════════════════════════════════════════════
// ORDER
// ═══════════════════════════════════════════════════════════════

model Order {
  id              String        @id @default(cuid())
  orderNumber     String        @unique
  customerId      String
  customerName    String
  customerEmail   String
  customerPhone   String?
  itemCount       Int           @default(0)
  subtotal        Decimal       @db.Decimal(10, 2)
  shippingCost    Decimal       @default(0) @db.Decimal(10, 2)
  tax             Decimal       @default(0) @db.Decimal(10, 2)
  discount        Decimal       @default(0) @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  currency        Currency      @default(USD)
  status          OrderStatus   @default(pending)
  paymentStatus   PaymentStatus @default(pending)
  paymentMethod   String?
  shippingAddress Json
  customerNote    String?
  internalNote    String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  paidAt          DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?

  customer Customer    @relation(fields: [customerId], references: [id])
  items    OrderItem[]
  quote    Quote?      @relation("QuoteToOrder")

  @@map("orders")
}

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String
  productId   String
  productName String
  productSku  String
  variantId   String?
  variantName String?
  quantity    Int
  unitPrice   Decimal @db.Decimal(10, 2)
  totalPrice  Decimal @db.Decimal(10, 2)

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@map("order_items")
}

// ═══════════════════════════════════════════════════════════════
// QUOTE
// ═══════════════════════════════════════════════════════════════

model Quote {
  id              String      @id @default(cuid())
  quoteNumber     String      @unique
  customerId      String?
  customerName    String
  customerEmail   String
  customerPhone   String?
  company         String?
  subtotal        Decimal?    @db.Decimal(10, 2)
  discount        Decimal     @default(0) @db.Decimal(10, 2)
  total           Decimal?    @db.Decimal(10, 2)
  currency        Currency    @default(USD)
  status          QuoteStatus @default(pending)
  validUntil      DateTime?
  customerMessage String?
  internalNotes   String?
  responseMessage String?
  orderId         String?     @unique
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  reviewedAt      DateTime?
  sentAt          DateTime?
  respondedAt     DateTime?

  customer Customer?   @relation(fields: [customerId], references: [id])
  order    Order?      @relation("QuoteToOrder", fields: [orderId], references: [id])
  items    QuoteItem[]

  @@map("quotes")
}

model QuoteItem {
  id          String   @id @default(cuid())
  quoteId     String
  productId   String?
  productName String
  sku         String?
  description String?
  quantity    Int
  unitPrice   Decimal? @db.Decimal(10, 2)
  totalPrice  Decimal? @db.Decimal(10, 2)

  quote   Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@map("quote_items")
}

// ═══════════════════════════════════════════════════════════════
// MESSAGE
// ═══════════════════════════════════════════════════════════════

model Message {
  id           String        @id @default(cuid())
  name         String
  email        String
  phone        String?
  company      String?
  subject      String
  message      String
  type         MessageType   @default(contact)
  status       MessageStatus @default(unread)
  isStarred    Boolean       @default(false)
  replyMessage String?
  repliedAt    DateTime?
  repliedById  String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  readAt       DateTime?

  repliedBy User? @relation("RepliedBy", fields: [repliedById], references: [id])

  @@map("messages")
}

// ═══════════════════════════════════════════════════════════════
// SETTINGS (Single row table)
// ═══════════════════════════════════════════════════════════════

model SiteSettings {
  id                       String   @id @default("default")
  siteName                 String   @default("Motico Solutions")
  siteDescription          String   @default("")
  contactEmail             String   @default("")
  contactPhone             String   @default("")
  address                  String   @default("")
  currency                 Currency @default(USD)
  taxRate                  Decimal  @default(0) @db.Decimal(5, 2)
  shippingFee              Decimal  @default(0) @db.Decimal(10, 2)
  freeShippingThreshold    Decimal? @db.Decimal(10, 2)
  orderNotificationEmail   String   @default("")
  lowStockAlertThreshold   Int      @default(10)
  enableEmailNotifications Boolean  @default(true)
  socialFacebook           String?
  socialInstagram          String?
  socialLinkedIn           String?
  socialYouTube            String?
  updatedAt                DateTime @updatedAt

  @@map("site_settings")
}
